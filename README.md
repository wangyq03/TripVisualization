# 🗺️ 路线可视化展示系统

一个功能完整的基于PHP和高德地图的Web应用，用于在地图上可视化展示和管理您的路线信息。

> **✨ 最新更新**：v3.3.0 智能路线着色！根据行程连贯性自动分配颜色，优化地图控件布局！

![GitHub](https://img.shields.io/badge/PHP-7.4+-blue)
![GitHub](https://img.shields.io/badge/License-MIT-green)
![GitHub](https://img.shields.io/badge/Version-v3.3.0-orange)

---

## 📑 目录

- [功能特性](#-功能特性)
- [快速开始](#-快速开始)
- [项目结构](#-项目结构)
- [详细使用](#-详细使用)
- [高级功能](#-高级功能)
- [API文档](#-api文档)
- [常见问题](#-常见问题)
- [技术栈](#-技术栈)
- [更新日志](#-更新日志)

---

## 🌟 功能特性

### 🗺️ 地图展示

- **高德地图集成**：使用高德地图 API v2.0，国内访问快速稳定
- **智能路径绘制**：自动绘制城市间的平滑曲线路径
- **智能路线着色**：✨ 根据行程连贯性自动分配颜色
  - 连贯路线（如：北京→杭州→上海）使用同一颜色
  - 不连贯时自动切换颜色，清晰区分不同路线链
  - 时序标记与路线颜色同步
- **往返路线分离**：相同城市往返路线自动分列显示，避免重叠
- **全屏显示**：一键全屏放大地图，支持ESC键快速退出
- **交互式标记**：
  - 起点/终点标记：鼠标悬停显示详细信息
  - 路线悬停：加粗显示并弹出信息提示框
  - 周期起始点/结束点：大型星形标记突出显示
  - 时序开关：独立控件，可显示/隐藏路线序号
- **优化的控件布局**：
  - 图例、时序开关、全屏按钮顶部对齐
  - 紧凑设计，最大化地图显示区域
  - 全屏模式下自动调整位置
- **日期筛选**：按日期范围筛选行程
- **实时统计**：显示总行程数、涉及城市数

### 📝 行程管理

- **多格式上传**：
  - ✅ CSV 文件（`.csv`）
  - ✅ Excel 文件（`.xlsx`, `.xls`）
  - 支持拖拽上传
- **智能解析**：
  - 自动识别中英文列名
  - 支持多种日期格式（`YYYY-MM-DD`、`YYYY/MM/DD`）
  - Excel日期序列号自动转换
- **数据预览**：上传前预览和验证数据
- **批量操作**：支持全量替换或增量添加
- **模板下载**：提供标准CSV模板

### 📍 城市管理（管理员）

- **城市信息维护**：添加、编辑、删除城市
- **坐标自动转换**：WGS84 → GCJ02（高德坐标系）
- **批量导入**：支持批量添加城市
- **数据验证**：自动验证经纬度合法性

### 🔐 用户系统

- **安全登录**：基于Token的认证机制
- **权限管理**：
  - 管理员：所有功能
  - 普通用户：地图展示 + 行程编辑
- **会话管理**：7天有效期，自动续期
- **用户菜单**：统一的用户信息和退出入口

### 🎨 用户体验

- **响应式设计**：完美支持桌面和移动设备
- **Toast通知**：优雅的成功/失败提示
- **加载状态**：实时显示操作进度
- **错误处理**：详细的错误信息和解决建议
- **自动备份**：修改数据时自动创建备份

---

## 🚀 快速开始

### 环境要求

- **PHP 7.4+** 或更高版本
- **Web服务器**（Apache、Nginx 或 PHP内置服务器）
- **现代浏览器**支持 JavaScript ES6+
- **高德地图 API Key**（免费申请）

### 1. 获取高德地图 API Key

**重要**：系统需要高德地图 API Key 才能正常显示地图。

#### 申请步骤：

1. 访问 [高德开放平台](https://lbs.amap.com/)
2. 注册/登录账号
3. 进入 [控制台](https://console.amap.com/dev/key/app)
4. 创建应用（名称任意，如"路线可视化系统"）
5. 添加Key：
   - 服务平台：选择 **Web端(JS API)**
   - Key名称：任意（如"路线地图"）
   - 白名单：可留空或填写域名
6. 复制生成的Key

#### 配置到项目：

编辑 `index.php`，找到第34行左右：

```html
<script src="https://webapi.amap.com/maps?v=2.0&key=YOUR_AMAP_KEY"></script>
```

将 `YOUR_AMAP_KEY` 替换为你的Key。

> 💡 **免费额度**：个人开发者免费 30万次/天，足够个人项目使用！

### 2. 服务器部署

```bash
# 上传项目文件
scp -r /path/to/project/* user@server:/var/www/html/

# 设置权限
chmod 755 data/
chmod 644 data/*

# 配置Web服务器（Apache/Nginx）
# 根目录指向项目目录
```

### 3. 登录系统

- **管理员**：`admin` / `admin123`
- **普通用户**：`user` / `123456`

### 4. 开始使用

1. **查看地图**：访问首页 `index.php`
2. **上传行程**：点击"行程编辑"，上传CSV或Excel文件
3. **管理城市**：管理员登录后可访问"城市管理"

---

## 📂 项目结构

```
maps/
├── 📁 api/                  # 后端API接口
│   ├── auth.php            # 用户认证API
│   ├── cities.php          # 城市数据API
│   └── trips.php           # 行程数据API
├── 📁 css/                  # 前端样式
│   └── common.css          # 公共样式（统一UI风格）
├── 📁 data/                 # 数据存储（JSON + CSV）
│   ├── cities.json         # 城市坐标数据
│   └── trips.csv           # 行程数据
├── 📁 js/                   # 前端JavaScript
│   ├── cities-manager.js   # 城市管理功能
│   ├── login.js            # 登录功能
│   ├── map.js              # 地图展示功能
│   ├── trips-editor.js     # 行程编辑功能
│   └── user-menu.js        # 用户菜单组件
├── 📄 index.php             # 主页面（地图展示）
├── 📄 trips-editor.php      # 行程编辑页面
├── 📄 cities-manager.php    # 城市管理页面（管理员）
├── 📄 login.html            # 登录页面
├── 📄 start-server.bat      # 快速启动脚本（Windows）
└── 📄 README.md             # 完整文档（使用说明 + API文档）
```

**核心文件说明**：
- **前端页面**：4个主要页面（登录、地图、编辑、管理）
- **后端API**：3个RESTful API（认证、城市、行程）
- **数据存储**：JSON格式城市库 + CSV格式行程数据
- **前端资源**：统一CSS样式 + 模块化JS脚本

---

## 📖 详细使用

### 上传行程数据

#### 方式1：CSV文件

**CSV格式要求**：

```csv
date,origin,destination
2025-01-15,北京,上海
2025-01-20,上海,深圳
2025-01-25,深圳,广州
```

**支持的列名**（自动识别）：
- **日期**：`date`、`日期`、`时间`
- **起点**：`origin`、`出发地`、`起点`、`from`
- **终点**：`destination`、`目的地`、`终点`、`to`

**支持的日期格式**：
- `2025-01-15` 或 `2025-1-5`
- `2025/01/15` 或 `2025/1/5`

#### 方式2：Excel文件

**Excel格式要求**：

| 日期 | 出发地 | 目的地 |
|------|--------|--------|
| 2025-01-15 | 北京 | 上海 |
| 2025-01-20 | 上海 | 深圳 |

**特点**：
- ✅ 支持 `.xlsx` 和 `.xls` 格式
- ✅ 自动识别中英文列名
- ✅ Excel日期序列号自动转换
- ✅ 读取第一个工作表

#### 上传步骤：

1. 点击导航栏"行程编辑"
2. 拖拽文件或点击选择
3. 点击"预览数据"检查
4. 确认无误后点击"上传数据"

### 管理城市数据

**仅管理员可访问**

#### 添加单个城市：

1. 进入"城市管理"页面
2. 在输入框中填写城市信息：
   ```
   城市名称: 经度 纬度 备注
   例如：
   杭州 120.1551 30.2741 浙江省会
   ```
3. 点击"验证数据"
4. 确认后点击"添加城市"

#### 批量添加城市：

粘贴多行数据，每行一个城市：
```
杭州 120.1551 30.2741 浙江省会
苏州 120.5954 31.2989 江苏省地级市
无锡 120.3019 31.5747 江苏省地级市
```

#### 坐标系统说明：

- **输入坐标**：WGS84（GPS标准坐标）
- **存储坐标**：WGS84（保持兼容性）
- **地图显示**：GCJ02（自动转换为高德坐标）

系统会自动将WGS84坐标转换为GCJ02，无需手动处理！

---

## 🎯 高级功能

### 🖥️ 全屏显示功能

#### 使用方法：

**进入全屏**：
1. 点击地图右上角的"全屏"按钮
2. 地图立即全屏显示，占据整个浏览器窗口
3. 按钮变为"退出全屏"

**退出全屏**：
- 方式1：点击"退出全屏"按钮
- 方式2：按 `ESC` 键

#### 特点：

- ✅ **一键全屏**：点击按钮即可全屏
- ✅ **自动适配**：地图自动调整到全屏尺寸
- ✅ **快捷键支持**：ESC键快速退出
- ✅ **美观按钮**：悬停特效，视觉反馈明显
- ✅ **状态切换**：按钮文字和颜色随状态变化

### 🗺️ 地图交互优化

#### 智能路线着色系统：✨ 新功能

系统根据行程的连贯性自动分配颜色，形成清晰的路线链：

**工作原理**：
1. **连贯判断**：当前行程的起点 = 上一行程的终点 → 使用相同颜色
2. **颜色切换**：起点不连贯时，自动切换到下一个颜色
3. **视觉一致**：时序标记与路线使用相同颜色

**示例**：
```
行程1: 北京 → 杭州     [蓝色]   (起始)
行程2: 杭州 → 上海     [蓝色]   (连贯，杭州相连)
行程3: 保定 → 北京     [紫色]   (不连贯，切换颜色)
行程4: 北京 → 唐山     [紫色]   (连贯，北京相连)
```

**优势**：
- ✅ 清晰识别完整路线链
- ✅ 快速理解行程逻辑
- ✅ 颜色自动分配，无需手动设置
- ✅ 6种颜色循环使用，区分度高

#### 路线显示：

- **默认状态**：实线，透明度 0.8
- **鼠标悬停**：
  - 加粗到 6px
  - 透明度提升到 1.0
  - 自动弹出信息框（起点→终点、日期、序号）
- **鼠标移开**：自动恢复默认状态

#### 往返路线分离：

系统自动识别往返路线，并分别显示在左右两侧，避免重叠：

```
北京 ────────────→ 上海  (第1次)
北京 ←──────────── 上海  (返回)
北京 ──────────────→ 上海  (第2次)
```

#### 地图控件布局优化：

**紧凑设计**，最大化地图显示区域：

```
[图例]  [时序开关]                    [全屏按钮]
  ↓         ↓                              ↓
top: 10px                              top: 10px
left: 10px  left: 200px                right: 10px
```

**全屏模式**：
```
top: 70px (避开全屏按钮)
```

**特点**：
- ✅ 所有控件顶部对齐
- ✅ 图例和时序开关独立模块
- ✅ 紧凑布局，占用空间最小
- ✅ 全屏/普通模式平滑切换

### 坐标转换机制

**为什么需要转换？**

中国地图使用加密坐标系统：
- **WGS84**：国际GPS标准，原始GPS数据
- **GCJ02**：国测局火星坐标，高德/腾讯地图使用
- 两者偏差：50-500米

**自动转换流程**：

```
GPS设备/国际地图 → WGS84坐标
          ↓
    存储到 cities.json
          ↓
    API 读取并转换
          ↓
    GCJ02 坐标 → 高德地图
          ↓
    ✅ 位置精确！
```

**优势**：
- ✅ 数据源兼容广泛（GPS、Google地图等）
- ✅ 原始数据保持标准格式
- ✅ 地图显示精确无偏差
- ✅ 对用户完全透明

### 数据备份机制

每次修改数据时，系统自动创建带时间戳的备份：

```
data/
├── trips.csv                          # 当前数据
├── trips_backup_2025-01-20_10-30-15.csv  # 备份1
├── trips_backup_2025-01-20_15-45-22.csv  # 备份2
├── cities.json                        # 当前数据
└── cities_backup_2025-01-20_11-20-30.json # 备份
```

---

## 🔌 API文档

### 行程数据 API

#### 📥 获取行程列表

```http
GET /api/trips.php?start_date=2025-01-01&end_date=2025-01-31
```

**响应**：
```json
{
  "success": true,
  "trips": [
    {
      "date": "2025-01-15",
      "origin": "北京",
      "destination": "上海",
      "timestamp": 1736899200
    }
  ],
  "cities": {
    "北京": {
      "latitude": 39.9099,
      "longitude": 116.4135
    }
  },
  "total": 10,
  "coordinateSystem": "GCJ02"
}
```

#### 📤 上传行程数据

```http
POST /api/trips.php
Content-Type: application/json

{
  "action": "upload",
  "trips": [
    {
      "origin": "北京",
      "destination": "上海",
      "date": "2025-01-15"
    }
  ]
}
```

**响应**：
```json
{
  "success": true,
  "message": "行程数据上传成功",
  "count": 1
}
```

### 城市数据 API

#### 📥 获取城市列表

```http
GET /api/cities.php
```

**响应**：
```json
{
  "success": true,
  "cities": [
    {
      "name": "北京",
      "latitude": 39.9042,
      "longitude": 116.4074,
      "note": "首都"
    }
  ],
  "total": 50
}
```

#### 📤 添加城市

```http
POST /api/cities.php
Content-Type: application/json

{
  "action": "add",
  "cities": [
    {
      "name": "杭州",
      "latitude": 30.2741,
      "longitude": 120.1551,
      "note": "浙江省会"
    }
  ]
}
```

### 用户认证 API

#### 🔐 登录

```http
POST /api/auth.php
Content-Type: application/json

{
  "action": "login",
  "username": "admin",
  "password": "admin123"
}
```

**响应**：
```json
{
  "success": true,
  "token": "eyJ0eXAiOi...",
  "user": {
    "username": "admin",
    "name": "管理员",
    "role": "admin"
  },
  "expires_in": 604800
}
```

#### 🔓 退出登录

```http
POST /api/auth.php
Content-Type: application/json

{
  "action": "logout"
}
```

---

## ❓ 常见问题

### Q1: 地图无法显示？

**A:** 检查以下几点：

1. ✅ 是否配置了高德地图 API Key
2. ✅ 打开浏览器控制台（F12），查看是否有错误
3. ✅ 确认网络连接正常
4. ✅ 检查Key是否正确、是否过期

### Q2: 上传CSV提示"城市不存在"？

**A:** 原因：行程中的城市在 `cities.json` 中不存在。

**解决方法**：
1. 管理员登录
2. 进入"城市管理"页面
3. 添加缺失的城市
4. 重新上传行程数据

### Q3: Excel文件无法识别？

**A:** 请确保：

1. ✅ 文件格式为 `.xlsx` 或 `.xls`
2. ✅ 第一行包含列名（日期、出发地、目的地）
3. ✅ 数据从第二行开始
4. ✅ 没有合并单元格

### Q4: 城市标记位置不准确？

**A:** 这可能是坐标系统问题。

系统已内置 **WGS84 → GCJ02 自动转换**，如果位置仍然不准：

1. 确认原始坐标是 WGS84（GPS标准）
2. 如果是从高德地图直接获取的坐标（已经是GCJ02），可能会重复转换

**临时解决**：在 `api/trips.php` 中注释掉转换代码（约232行）。

### Q5: 忘记密码怎么办？

**A:** 编辑 `api/auth.php`，重新生成密码哈希：

```php
// 运行这段代码获取新密码的哈希
echo password_hash('new_password', PASSWORD_DEFAULT);

// 然后替换到用户数组中
$users = [
    'admin' => [
        'password' => '新的哈希值',
        // ...
    ]
];
```

### Q6: 如何强制刷新缓存？

**A:** 使用硬刷新：

- **Windows**: `Ctrl + Shift + R` 或 `Ctrl + F5`
- **Mac**: `Cmd + Shift + R`

---

## 🛡️ 安全特性

- **Token认证**：基于JWT的无状态认证
- **密码安全**：使用 `password_hash()` 进行哈希
- **会话管理**：7天有效期，自动过期
- **输入验证**：前后端双重验证
- **SQL注入防护**：使用JSON存储，无SQL操作
- **XSS防护**：输出内容进行转义
- **文件备份**：防止误操作导致数据丢失

---

## 🎨 技术栈

### 后端
- **PHP 7.4+**
- **JSON** 数据存储
- **CSV** 文件处理

### 前端
- **HTML5** + **CSS3** + **JavaScript ES6+**
- **高德地图 JS API v2.0**
- **SheetJS** (XLSX.js) - Excel文件解析
- **原生CSS**（Grid, Flexbox）
- **响应式设计**

### 地图服务
- **高德地图 JavaScript API v2.0**
- **GCJ02坐标系**（火星坐标）
- **自动坐标转换**（WGS84 → GCJ02）

---

## 🔄 更新日志

### v3.3.0 (2025-01-20) - 当前版本

#### 🎉 新增功能
- ✨ **智能路线着色系统**：根据行程连贯性自动分配颜色
  - 连贯路线使用同一颜色（如：北京→杭州→上海）
  - 不连贯时自动切换颜色
  - 时序标记与路线颜色同步
  - 控制台输出详细的连贯性分析日志

#### 🎨 UI/UX优化
- 🔧 **地图控件布局优化**：
  - 时序开关从图例中独立出来
  - 所有控件（图例、时序、全屏）顶部对齐
  - 统一间距（top: 10px），最小化占用
  - 全屏模式下自动调整位置（top: 70px）
- 📐 **紧凑设计**：
  - 减小图例尺寸和间距
  - 图标从20px缩小到18px
  - padding优化，释放更多地图空间
- 🗑️ **移除冗余功能**：删除图例收起/展开功能

#### 🔧 技术改进
- 🎯 **颜色分配算法**：
  - 从基于次数分配改为基于连贯性分配
  - 新增 `tripColorMap` 存储每个行程的颜色索引
  - 优化颜色传递机制
- 📊 **调试增强**：控制台输出每个行程的连贯性分析

#### 📝 文档更新
- 📖 完整的智能路线着色系统说明
- 🎯 地图交互优化详细文档
- 🖼️ 控件布局示意图

### v3.2.0 (2025-01-20)

#### 🎉 新增功能
- ✨ **全屏显示**：地图右上角新增全屏按钮
  - 一键全屏查看地图
  - 支持ESC键快速退出
  - 自动调整地图尺寸
  - 美观的按钮设计和交互效果

#### 📝 文档更新
- 📖 更新README，添加全屏功能使用说明
- 🎯 完善高级功能章节

### v3.1.0 (2025-01-20)

#### 🎉 新增功能
- ✨ **Excel文件支持**：可上传 `.xlsx` 和 `.xls` 文件
- ✨ **智能列识别**：自动识别中英文列名
- ✨ **Excel日期转换**：自动转换Excel序列日期
- 🎨 **地图交互优化**：
  - 移除城市标签，使用地图自带标签
  - 标记点改为小圆点（8px）
  - 鼠标悬停显示详细信息

#### 🔧 优化改进
- 🚀 **文件识别增强**：`.csv`、`.xlsx`、`.xls` 统一处理
- 🎯 **坐标系统**：完善 WGS84 → GCJ02 自动转换
- 📝 **文档整合**：所有说明整合到 README
- 🧹 **代码清理**：删除测试文件和冗余文档

#### 🗑️ 清理文件
- 删除测试工具（`test-*.html`、`test-*.bat`）
- 删除冗余文档（整合到README）
- 删除临时配置文件

### v3.0.0 (2024-12-20)

#### 🗺️ 重大更新
- **地图服务迁移**：从 Leaflet + OpenStreetMap 升级到高德地图
- **性能提升**：国内访问速度提升 75%
- **稳定性改善**：解决OSM加载不稳定问题

#### ✨ 新增功能
- 高德地图集成
- 坐标自动转换（WGS84 → GCJ02）
- 地图控件（缩放、比例尺）
- 自动适配视图

### v2.1.0 (2025-01-19)

#### 🔐 认证系统
- 全局用户认证
- 基于角色的权限控制
- 7天会话有效期
- 用户菜单组件

### v2.0.0 (2025-01-19)

#### ✨ 核心功能
- 行程编辑功能
- CSV上传支持
- 数据预览和验证
- 自动备份机制
- Toast通知系统

### v1.0.0 (初始版本)

#### 🎯 基础功能
- 地图展示
- 日期筛选
- 路径绘制
- 响应式设计

---

## 🎯 为什么选择高德地图？

相比 OpenStreetMap：

| 特性 | OpenStreetMap | 高德地图 |
|------|---------------|----------|
| 🚀 国内访问速度 | ⚠️ 慢（3-8秒） | ✅ 快（1-2秒） |
| 📡 稳定性 | ⚠️ 不稳定 | ✅ 非常稳定 |
| 🗺️ 中文地图 | ⚠️ 一般 | ✅ 优秀 |
| 💰 免费额度 | ✅ 无限制 | ✅ 30万次/天 |
| 🔄 数据更新 | ⚠️ 滞后 | ✅ 实时更新 |
| ⚙️ 配置难度 | ✅ 无需配置 | ⚠️ 需申请Key |

**推荐场景**：
- ✅ 国内用户访问的项目
- ✅ 需要稳定地图服务
- ✅ 对中文显示有要求
- ✅ 个人项目（免费额度充足）

---

## 📱 浏览器支持

| 浏览器 | 最低版本 |
|--------|----------|
| Chrome | 70+ |
| Firefox | 65+ |
| Safari | 12+ |
| Edge | 79+ |
| 移动浏览器 | 支持 |

---

## 📄 许可证

MIT License

版权所有 (c) 2025

特此免费授予任何获得本软件及相关文档文件（"软件"）副本的人不受限制地处置该软件的权利。

---

## 🤝 贡献

欢迎提交 Issue 和 Pull Request！

**贡献指南**：
1. Fork 本仓库
2. 创建特性分支 (`git checkout -b feature/AmazingFeature`)
3. 提交更改 (`git commit -m 'Add some AmazingFeature'`)
4. 推送到分支 (`git push origin feature/AmazingFeature`)
5. 开启 Pull Request

---

## 📞 支持

- 📖 **完整文档**：本 README 包含所有使用说明
- 📧 **问题反馈**：提交 GitHub Issue
- 🌐 **高德地图文档**：https://lbs.amap.com/api/javascript-api/summary
- 💡 **技术支持**：查看常见问题章节

---

**感谢使用路线可视化展示系统！** 🎉

如有问题或建议，欢迎随时提出！
