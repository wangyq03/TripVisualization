# 🗺️ 路线可视化展示系统

一个功能完整的基于PHP和高德地图的Web应用，用于在地图上可视化展示和管理您的路线信息。

> **✨ 最新更新**：v3.5.0 全面数据库集成！城市管理和用户认证完全基于远程MySQL数据库，提供企业级数据管理和安全性！

![GitHub](https://img.shields.io/badge/PHP-7.4+-blue)
![GitHub](https://img.shields.io/badge/License-MIT-green)
![GitHub](https://img.shields.io/badge/Version-v3.4.0-orange)

---

## 📑 目录

- [功能特性](#-功能特性)
- [快速开始](#-快速开始)
- [项目结构](#-项目结构)
- [详细使用](#-详细使用)
- [高级功能](#-高级功能)
- [API文档](#-api文档)
- [常见问题](#-常见问题)
- [技术栈](#-技术栈)
- [更新日志](#-更新日志)

---

## 🌟 功能特性

### 🗺️ 地图展示

- **高德地图集成**：使用高德地图 API v2.0，国内访问快速稳定
- **智能路径绘制**：自动绘制城市间的平滑曲线路径
- **智能路线着色**：✨ 根据行程连贯性自动分配颜色
  - 连贯路线（如：北京→杭州→上海）使用同一颜色
  - 不连贯时自动切换颜色，清晰区分不同路线链
  - 时序标记与路线颜色同步
- **往返路线分离**：相同城市往返路线自动分列显示，避免重叠
- **全屏显示**：一键全屏放大地图，支持ESC键快速退出
- **交互式标记**：
  - 起点/终点标记：鼠标悬停显示详细信息
  - 路线悬停：加粗显示并弹出信息提示框
  - 周期起始点/结束点：大型星形标记突出显示
  - 时序开关：独立控件，可显示/隐藏路线序号
- **优化的控件布局**：
  - 图例、时序开关、全屏按钮顶部对齐
  - 紧凑设计，最大化地图显示区域
  - 全屏模式下自动调整位置
- **日期筛选**：按日期范围筛选行程
- **实时统计**：显示总行程数、涉及城市数

### 📝 行程管理

- **多格式上传**：
  - ✅ CSV 文件（`.csv`）
  - ✅ Excel 文件（`.xlsx`, `.xls`）
  - 支持拖拽上传
- **智能解析**：
  - 自动识别中英文列名
  - 支持多种日期格式（`YYYY-MM-DD`、`YYYY/MM/DD`）
  - Excel日期序列号自动转换
- **数据预览**：上传前预览和验证数据
- **批量操作**：支持全量替换或增量添加
- **模板下载**：提供标准CSV模板

### 📍 城市管理（管理员）

- **🏙️ 远程数据库集成**：城市数据完全存储在远程MySQL数据库
- **🗄️ 企业级表结构**：完整索引、软删除、时间戳追踪、审计日志
- **📊 智能验证**：自动坐标范围检查、重复数据验证、数据完整性保证
- **🔄 坐标转换**：WGS84 → GCJ02（高德坐标系）自动转换
- **📥 多模式导入**：支持批量导入、单个添加、JSON文件导入
- **🌐 数据库优先**：以数据库为主存储，JSON文件作为备份
- **🔧 管理界面**：
  - Web界面管理：`cities-manager.php` - 可视化城市管理界面

  - 个人中心：`profile.php` - 用户信息管理

### 🔐 用户认证系统

- **🛡️ 远程数据库认证**：用户数据完全存储在MySQL数据库
- **🔐 安全登录机制**：基于密码哈希的安全认证（password_hash）
- **👥 权限分级管理**：
  - **管理员**：地图展示 + 行程编辑 + 城市管理 + 用户管理
  - **普通用户**：地图展示 + 行程编辑 + 个人信息管理
- **📱 会话管理**：7天有效期，自动续期，安全的Token机制
- **👤 个人中心**：
  - 用户信息展示和统计
  - 密码修改功能
  - 权限级别显示
  - 账户状态管理
- **🌐 统一用户界面**：用户菜单组件，统一的登录/登出体验

### 🎨 用户体验

- **响应式设计**：完美支持桌面和移动设备
- **Toast通知**：优雅的成功/失败提示
- **加载状态**：实时显示操作进度
- **错误处理**：详细的错误信息和解决建议
- **自动备份**：修改数据时自动创建备份

---

## 🚀 快速开始

### 环境要求

- **PHP 7.4+** 或更高版本
- **Web服务器**（Apache、Nginx 或 PHP内置服务器）
- **MySQL 5.7+** 或更高版本（存储用户和城市数据）
- **现代浏览器**支持 JavaScript ES6+
- **高德地图 API Key**（免费申请）
- **PDO MySQL扩展**（PHP数据库连接）

### 1. 配置数据库

**重要**：系统现在需要MySQL数据库来存储用户和城市数据。

#### 数据库配置：

1. 创建数据库：
```sql
CREATE DATABASE route_visualization CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;
```

2. 导入表结构：
请手动创建用户和城市相关的数据表结构。


3. 创建数据库用户（推荐）：
```sql
CREATE USER 'route_user'@'localhost' IDENTIFIED BY 'your_secure_password';
GRANT SELECT, INSERT, UPDATE, DELETE ON route_visualization.* TO 'route_user'@'localhost';
FLUSH PRIVILEGES;
```

4. 配置数据库连接：
编辑 `api/config.php`，配置数据库连接参数。

5. 修改数据库连接配置：
编辑 `api/config.php`，修改数据库连接参数：
```php
$db_config = [
    'host' => 'localhost',        // 数据库主机
    'dbname' => 'route_visualization',  // 数据库名
    'username' => 'route_user',  // 数据库用户名
    'password' => 'your_secure_password',  // 数据库密码
    'charset' => 'utf8mb4'
];
```
6. 导入城市数据（可选）：
手动通过城市管理界面添加城市数据。

> 📁 **配置文件**：`api/config.php` 存放数据库连接参数，请确保文件权限安全。
> 🛡️ **安全提示**：不要将数据库密码提交到版本控制系统，建议使用环境变量。
> 🏙️ **城市数据**：现在支持MySQL存储，提供更好的性能和可扩展性！

### 2. 获取高德地图 API Key

**重要**：系统需要高德地图 API Key 才能正常显示地图。

#### 申请步骤：

1. 访问 [高德开放平台](https://lbs.amap.com/)
2. 注册/登录账号
3. 进入 [控制台](https://console.amap.com/dev/key/app)
4. 创建应用（名称任意，如"路线可视化系统"）
5. 添加Key：
   - 服务平台：选择 **Web端(JS API)**
   - Key名称：任意（如"路线地图"）
   - 白名单：可留空或填写域名
6. 复制生成的Key（格式类似：`a1b2c3d4e5f6g7h8i9j0k1l2m3n4o5p6`）

#### 配置到项目：

编辑 `index.php`，找到第34行左右：

```html
<script src="https://webapi.amap.com/maps?v=2.0&key=YOUR_AMAP_KEY"></script>
```

将 `YOUR_AMAP_KEY` 替换为你的Key。

> 💡 **免费额度**：个人开发者免费 30万次/天，足够个人项目使用！

### 2. 本地测试（推荐）

**Windows用户**：

```bash
# 双击运行
start-server.bat

# 或手动启动
php -S localhost:8000
```

**Mac/Linux用户**：

```bash
php -S localhost:8000
```

然后访问：`http://localhost:8000`

### 3. 服务器部署

```bash
# 上传项目文件
scp -r /path/to/project/* user@server:/var/www/html/

# 设置权限
chmod 755 data/
chmod 644 data/*

# 配置Web服务器（Apache/Nginx）
# 根目录指向项目目录
```

### 4. 登录系统

**默认账户**（部署后请立即修改）：
- **管理员**：`admin` / `admin123`
- **普通用户**：`user` / `user123`

> ⚠️ **安全提醒**：部署后请立即修改默认密码，使用强密码策略。

### 5. 开始使用

1. **查看地图**：访问首页 `index.php`
2. **上传行程**：点击"行程编辑"，上传CSV或Excel文件
3. **管理城市**：管理员登录后可访问"城市管理"
4. **个人中心**：所有用户可访问"个人中心"管理个人信息和密码

---

## 📂 项目结构

TripVisualization/
├── 📁 api/                  # 后端API接口
│   ├── config.php          # 数据库配置文件
│   ├── auth.php            # 用户认证API
│   ├── cities.php          # 城市数据API
│   ├── common.php          # 公共函数
│   └── trips.php           # 行程数据API
├── 📄 create_users.sql     # 用户表结构和默认数据
├── 📄 .gitignore          # 版本控制忽略文件
├── 📁 css/                  # 前端样式
│   └── common.css          # 公共样式
├── 📁 data/                 # 数据存储
│   ├── cities.json         # 城市坐标数据
│   └── trips.csv           # 行程数据
├── 📁 js/                   # 前端JavaScript
│   ├── cities-manager.js   # 城市管理功能
│   ├── login.js            # 登录功能
│   ├── map.js              # 地图展示功能
│   ├── trips-editor.js     # 行程编辑功能
│   └── user-menu.js        # 用户菜单组件
├── 📄 index.php             # 主页面（地图展示）
├── 📄 trips-editor.php      # 行程编辑页面
├── 📄 cities-manager.php    # 城市管理页面
├── 📄 login.html            # 登录页面
├── 📄 profile.php           # 个人中心页面
└── 📄 README.md             # 项目文档
```

**核心文件说明**：
- **前端页面**：5个主要页面（登录、地图、编辑、管理、个人中心）
- **后端API**：3个RESTful API（认证、城市、行程）
- **数据库**：MySQL远程数据库（用户 + 城市数据）
- **数据存储**：
  - **远程MySQL数据库**：用户数据 + 城市数据（主要存储）
  - **JSON格式**：城市坐标数据（备份和回退）
  - **CSV格式**：行程数据（本地文件存储）
- - **配置文件**：`config.php` 数据库连接配置
- **文档**：`README.md` 项目完整说明文档

---

## 📖 详细使用

### 上传行程数据

#### 方式1：CSV文件

**CSV格式要求**：

```csv
date,origin,destination
2025-01-15,北京,上海
2025-01-20,上海,深圳
2025-01-25,深圳,广州
```

**支持的列名**（自动识别）：
- **日期**：`date`、`日期`、`时间`
- **起点**：`origin`、`出发地`、`起点`、`from`
- **终点**：`destination`、`目的地`、`终点`、`to`

**支持的日期格式**：
- `2025-01-15` 或 `2025-1-5`
- `2025/01/15` 或 `2025/1/5`

#### 方式2：Excel文件

**Excel格式要求**：

| 日期 | 出发地 | 目的地 |
|------|--------|--------|
| 2025-01-15 | 北京 | 上海 |
| 2025-01-20 | 上海 | 深圳 |

**特点**：
- ✅ 支持 `.xlsx` 和 `.xls` 格式
- ✅ 自动识别中英文列名
- ✅ Excel日期序列号自动转换
- ✅ 读取第一个工作表

#### 上传步骤：

1. 点击导航栏"行程编辑"
2. 拖拽文件或点击选择
3. 点击"预览数据"检查
4. 确认无误后点击"上传数据"

### 管理城市数据

**仅管理员可访问**

#### 📊 数据库管理

系统v3.4.0支持两种城市数据存储模式：

1. **MySQL数据库**（推荐）：
   - 高性能：索引支持，查询更快
   - 可扩展：支持大量城市数据
   - 数据安全：事务支持，自动备份

2. **JSON文件**（备用）：
   - 向后兼容：自动回退机制
   - 备份作用：保存原始数据

#### 🏙️ 导入城市数据

手动通过城市管理界面添加城市数据。

#### 📝 添加城市

**单个城市添加**：
1. 进入"城市管理"页面
2. 在输入框中填写：
   ```
   城市名称,纬度,经度,备注
   例如：杭州,30.2741,120.1551,浙江省会
   ```
3. 点击"验证数据"检查坐标有效性
4. 确认后点击"添加城市"

**批量城市添加**：
```
杭州,30.2741,120.1551,浙江省会
苏州,31.2989,120.5954,江苏省地级市
无锡,31.5747,120.3019,江苏省地级市
```

#### 🔧 数据管理

- **数据库验证**：自动检查重复数据和坐标范围
- **软删除**：支持数据恢复的操作方式

#### 🌐 坐标系统

- **WGS84存储**：标准GPS坐标，国际兼容
- **GCJ02显示**：自动转换为高德坐标系
- **API转换**：支持 `?convert=gcj02` 参数
- **精度保证**：转换算法精确，位置偏差最小

> 💡 **新特性**：v3.4.0起，城市数据优先从数据库读取，如果数据库不可用自动回退到JSON文件！

---

## 🎯 高级功能

### 🖥️ 全屏显示功能

#### 使用方法：

**进入全屏**：
1. 点击地图右上角的"全屏"按钮
2. 地图立即全屏显示，占据整个浏览器窗口
3. 按钮变为"退出全屏"

**退出全屏**：
- 方式1：点击"退出全屏"按钮
- 方式2：按 `ESC` 键

#### 特点：

- ✅ **一键全屏**：点击按钮即可全屏
- ✅ **自动适配**：地图自动调整到全屏尺寸
- ✅ **快捷键支持**：ESC键快速退出
- ✅ **美观按钮**：悬停特效，视觉反馈明显
- ✅ **状态切换**：按钮文字和颜色随状态变化

### 🗺️ 地图交互优化

#### 智能路线着色系统：✨ 新功能

系统根据行程的连贯性自动分配颜色，形成清晰的路线链：

**工作原理**：
1. **连贯判断**：当前行程的起点 = 上一行程的终点 → 使用相同颜色
2. **颜色切换**：起点不连贯时，自动切换到下一个颜色
3. **视觉一致**：时序标记与路线使用相同颜色

**示例**：
```
行程1: 北京 → 杭州     [蓝色]   (起始)
行程2: 杭州 → 上海     [蓝色]   (连贯，杭州相连)
行程3: 保定 → 北京     [紫色]   (不连贯，切换颜色)
行程4: 北京 → 唐山     [紫色]   (连贯，北京相连)
```

**优势**：
- ✅ 清晰识别完整路线链
- ✅ 快速理解行程逻辑
- ✅ 颜色自动分配，无需手动设置
- ✅ 6种颜色循环使用，区分度高

#### 路线显示：

- **默认状态**：实线，透明度 0.8
- **鼠标悬停**：
  - 加粗到 6px
  - 透明度提升到 1.0
  - 自动弹出信息框（起点→终点、日期、序号）
- **鼠标移开**：自动恢复默认状态

#### 往返路线分离：

系统自动识别往返路线，并分别显示在左右两侧，避免重叠：

```
北京 ────────────→ 上海  (第1次)
北京 ←──────────── 上海  (返回)
北京 ──────────────→ 上海  (第2次)
```

#### 地图控件布局优化：

**紧凑设计**，最大化地图显示区域：

```
[图例]  [时序开关]                    [全屏按钮]
  ↓         ↓                              ↓
top: 10px                              top: 10px
left: 10px  left: 200px                right: 10px
```

**全屏模式**：
```
top: 70px (避开全屏按钮)
```

**特点**：
- ✅ 所有控件顶部对齐
- ✅ 图例和时序开关独立模块
- ✅ 紧凑布局，占用空间最小
- ✅ 全屏/普通模式平滑切换

### 坐标转换机制

**为什么需要转换？**

中国地图使用加密坐标系统：
- **WGS84**：国际GPS标准，原始GPS数据
- **GCJ02**：国测局火星坐标，高德/腾讯地图使用
- 两者偏差：50-500米

**自动转换流程**：

```
GPS设备/国际地图 → WGS84坐标
          ↓
    存储到 cities.json
          ↓
    API 读取并转换
          ↓
    GCJ02 坐标 → 高德地图
          ↓
    ✅ 位置精确！
```

**优势**：
- ✅ 数据源兼容广泛（GPS、Google地图等）
- ✅ 原始数据保持标准格式
- ✅ 地图显示精确无偏差
- ✅ 对用户完全透明

### 数据备份机制

每次修改数据时，系统自动创建带时间戳的备份：

```
data/
├── trips.csv                          # 当前数据
├── trips_backup_2025-01-20_10-30-15.csv  # 备份1
├── trips_backup_2025-01-20_15-45-22.csv  # 备份2
├── cities.json                        # 当前数据
└── cities_backup_2025-01-20_11-20-30.json # 备份
```

---

## 🔌 API文档

### 行程数据 API

#### 📥 获取行程列表

```http
GET /api/trips.php?start_date=2025-01-01&end_date=2025-01-31
```

**响应**：
```json
{
  "success": true,
  "trips": [
    {
      "date": "2025-01-15",
      "origin": "北京",
      "destination": "上海",
      "timestamp": 1736899200
    }
  ],
  "cities": {
    "北京": {
      "latitude": 39.9099,
      "longitude": 116.4135
    }
  },
  "total": 10,
  "coordinateSystem": "GCJ02"
}
```

#### 📤 上传行程数据

```http
POST /api/trips.php
Content-Type: application/json

{
  "action": "upload",
  "trips": [
    {
      "origin": "北京",
      "destination": "上海",
      "date": "2025-01-15"
    }
  ]
}
```

**响应**：
```json
{
  "success": true,
  "message": "行程数据上传成功",
  "count": 1
}
```

### 城市数据 API

#### 📥 获取城市列表

```http
GET /api/cities.php
```

**响应**：
```json
{
  "success": true,
  "cities": [
    {
      "name": "北京",
      "latitude": 39.9042,
      "longitude": 116.4074,
      "note": "首都"
    }
  ],
  "total": 50
}
```

#### 📤 添加城市

```http
POST /api/cities.php
Content-Type: application/json

{
  "action": "add",
  "cities": [
    {
      "name": "杭州",
      "latitude": 30.2741,
      "longitude": 120.1551,
      "note": "浙江省会"
    }
  ]
}
```

### 数据库配置

#### 📄 配置文件

系统已优化数据库配置管理：

**配置文件分离**：
- `api/config.php.example` - 配置模板（可提交到版本控制）
- `api/config.php` - 实际配置文件（需手动创建，包含敏感信息）

**安全措施**：
- `.gitignore` 已配置，防止敏感配置文件泄露
- 支持环境变量覆盖配置
- 使用专用数据库用户建议

系统使用 `api/config.php` 存储数据库连接参数：

```php
<?php
// 数据库配置
$db_config = [
    'host' => 'localhost',        // 数据库主机
    'dbname' => 'route_visualization',  // 数据库名
    'username' => 'your_db_user',  // 数据库用户名
    'password' => 'your_secure_password',  // 数据库密码
    'charset' => 'utf8mb4',
    'options' => [
        PDO::ATTR_ERRMODE => PDO::ERRMODE_EXCEPTION,
        PDO::ATTR_DEFAULT_FETCH_MODE => PDO::FETCH_ASSOC,
        PDO::ATTR_EMULATE_PREPARES => false,
    ]
];
```

#### 🛡️ 安全配置建议

1. **专用数据库用户**：
```sql
-- 创建专用用户（不要使用root）
CREATE USER 'route_app'@'localhost' IDENTIFIED BY 'StrongPassword123!';
-- 只授予必要权限
GRANT SELECT, INSERT, UPDATE, DELETE ON route_visualization.* TO 'route_app'@'localhost';
FLUSH PRIVILEGES;
```

2. **环境变量配置**：
```php
// 推荐使用环境变量
$db_config = [
    'host' => $_ENV['DB_HOST'] ?? 'localhost',
    'dbname' => $_ENV['DB_NAME'] ?? 'route_visualization', 
    'username' => $_ENV['DB_USER'] ?? 'route_app',
    'password' => $_ENV['DB_PASS'] ?? 'default_password'
];
```

3. **文件安全**：
```bash
# 设置适当的文件权限
chmod 640 api/config.php
chown www-data:www-data api/config.php
```

#### 🔄 从文件系统迁移

如果您要从旧版本（文件存储用户）迁移到MySQL：

1. **备份现有数据**：
```bash
cp api/auth.php api/auth.php.backup
```

2. **部署新配置**：
```bash
# 复制配置模板
cp api/config.php.example api/config.php
# 编辑配置文件
nano api/config.php
```

3. **导入用户表**：
```bash
mysql -u root -p route_visualization < create_users.sql
```

### 用户认证 API

```http
POST /api/auth.php
Content-Type: application/json

{
  "action": "login",
  "username": "admin",
  "password": "admin123"
}
```

**响应**：
```json
{
  "success": true,
  "token": "eyJ0eXAiOi...",
  "user": {
    "username": "admin",
    "name": "管理员",
    "role": "admin"
  },
  "expires_in": 604800
}
```

#### 🔓 退出登录

```http
POST /api/auth.php
Content-Type: application/json

{
  "action": "logout"
}
```

---

## ❓ 常见问题

### Q1: 地图无法显示？

**A:** 检查以下几点：

1. ✅ 是否配置了高德地图 API Key
2. ✅ 打开浏览器控制台（F12），查看是否有错误
3. ✅ 确认网络连接正常
4. ✅ 检查Key是否正确、是否过期

### Q2: 上传CSV提示"城市不存在"？

**A:** 原因：行程中的城市在 `cities.json` 中不存在。

**解决方法**：
1. 管理员登录
2. 进入"城市管理"页面
3. 添加缺失的城市
4. 重新上传行程数据

### Q3: Excel文件无法识别？

**A:** 请确保：

1. ✅ 文件格式为 `.xlsx` 或 `.xls`
2. ✅ 第一行包含列名（日期、出发地、目的地）
3. ✅ 数据从第二行开始
4. ✅ 没有合并单元格

### Q4: 城市标记位置不准确？

**A:** 这可能是坐标系统问题。

系统已内置 **WGS84 → GCJ02 自动转换**，如果位置仍然不准：

1. 确认原始坐标是 WGS84（GPS标准）
2. 如果是从高德地图直接获取的坐标（已经是GCJ02），可能会重复转换

**临时解决**：在 `api/trips.php` 中注释掉转换代码（约232行）。

### Q5: 忘记密码怎么办？

**A:** 编辑 `api/auth.php`，重新生成密码哈希：

```php
// 运行这段代码获取新密码的哈希
echo password_hash('new_password', PASSWORD_DEFAULT);

// 然后替换到用户数组中
$users = [
    'admin' => [
        'password' => '新的哈希值',
        // ...
    ]
];
```

### Q6: 如何强制刷新缓存？

**A:** 使用硬刷新：

- **Windows**: `Ctrl + Shift + R` 或 `Ctrl + F5`
- **Mac**: `Cmd + Shift + R`

---

## 🛡️ 安全特性

- **Token认证**：基于JWT的无状态认证
- **密码安全**：使用 `password_hash()` 进行哈希
- **会话管理**：7天有效期，自动过期
- **输入验证**：前后端双重验证
- **SQL注入防护**：使用JSON存储，无SQL操作
- **XSS防护**：输出内容进行转义
- **文件备份**：防止误操作导致数据丢失

---

## 🎨 技术栈

### 后端
- **PHP 7.4+**
- **MySQL 5.7+** 数据库存储（用户 + 城市）
- **JSON** 数据存储（备份）
- **CSV** 文件处理（行程数据）

### 前端
- **HTML5** + **CSS3** + **JavaScript ES6+**
- **高德地图 JS API v2.0**
- **SheetJS** (XLSX.js) - Excel文件解析
- **原生CSS**（Grid, Flexbox）
- **响应式设计**

### 地图服务
- **高德地图 JavaScript API v2.0**
- **GCJ02坐标系**（火星坐标）
- **自动坐标转换**（WGS84 → GCJ02）

---

## 🔄 更新日志

### v3.5.0 (2025-12-22) - 当前版本

#### 🌐 全面数据库集成（重大更新）

**数据库架构完善**：
- 🏢 **远程MySQL集成**：城市管理和用户认证完全基于远程数据库
- 🔐 **安全认证升级**：用户数据从文件存储升级到MySQL数据库认证
- 🏙️ **城市管理优化**：城市数据CRUD操作完全数据库化
- 👤 **个人中心新增**：完整的用户信息管理和密码修改功能

**功能增强**：
- 📊 **数据完整性**：数据库事务支持，确保数据一致性
- 🛡️ **安全强化**：密码哈希存储，角色权限管理，会话安全
- 📱 **用户体验**：统一用户界面，个人中心，响应式设计
- 🔄 **数据同步**：数据库优先，自动回退机制

**新增页面**：
- `profile.php` - 个人中心页面
- 完整的密码修改功能
- 用户统计信息展示
- 权限级别管理

**技术改进**：
- 🗄️ **数据库优化**：索引、外键约束、软删除
- 🔧 **API完善**：RESTful API设计，统一响应格式
- 📝 **错误处理**：完善的异常处理和日志记录
- 🎨 **UI/UX优化**：现代化界面设计，流畅交互体验

#### 重要变更
- **用户认证**：从文件存储升级到MySQL数据库认证
- **城市管理**：完全基于数据库的CRUD操作
- **个人中心**：新增完整的用户管理功能
- **数据安全**：企业级数据安全和管理能力

### v3.4.0 (2025-01-22)

#### 🏙️ 城市数据库优化（重大更新）

**数据库升级**：
- 🔧 **MySQL存储**：城市数据从JSON文件迁移到MySQL数据库
  - 新增 `create_cities.sql` 表结构创建脚本
  - 支持索引、软删除、时间戳追踪
  - 可选GCJ02坐标缓存表提升性能
- 🔄 **双重模式**：数据库优先，自动回退到JSON文件
- 📊 **数据验证**：自动检查坐标范围、重复数据

**管理工具**：
- 📥 **城市管理界面**：`cities-manager.php` 可视化管理界面
  - 支持单个添加、批量操作、数据验证
  - 实时错误提示和操作反馈

**API增强**：
- 🌐 **数据库优先**：`api/cities.php` 优先从数据库读取
- 🔄 **向后兼容**：数据库失败时自动使用JSON文件
- 📊 **扩展字段**：支持创建时间、更新时间、创建者追踪

**性能优化**：
- ⚡ **数据库索引**：支持高效的城市查询
- 🔍 **地理查询**：支持按坐标范围搜索

**数据质量**：
- ✅ **输入验证**：严格的坐标范围检查（-90~90°, -180~180°）
- 🇨🇳 **中国验证**：可选的中国境内坐标范围验证
- 🔍 **重复检查**：防止重复城市名称
- 📈 **统计信息**：实时显示新增、更新、跳过、错误数量

**用户体验**：
- 🎨 **管理界面**：增强的城市管理界面
- 📊 **数据统计**：城市数量、有效坐标、今日更新统计
- 🔄 **批量操作**：支持批量添加、更新、删除
- 💡 **操作提示**：详细的错误信息和解决建议

#### 🗂️ 新增文件

**数据库相关**：
- `create_cities.sql` - 城市表结构和索引
- `import_cities.php` - 数据导入工具（Web + CLI）
- `quick_import.sh` - 快速导入脚本
- `test_db.php` - 数据库测试工具
- `fix_foreign_keys.php` - 外键修复工具
- `CITIES_DATABASE_SETUP.md` - 完整设置文档

#### 📝 重要变更

- **城市数据存储**：从纯JSON文件改为MySQL数据库存储
- **API响应格式**：新增数据库字段（id、created_at、updated_at等）
- **城市管理界面**：支持数据库操作和统计信息
- **导入流程**：提供多种导入方式和强大的错误处理

#### ⚠️ 部署注意事项

1. **数据库升级**：
   ```bash
   mysql -u root -p route_visualization < create_cities.sql
   ```

2. **城市数据导入**：
   ```bash
   ./quick_import.sh
   ```

3. **测试验证**：
   - 访问 `test_db.php` 检查数据库状态
   - 访问 `import_cities.php` 测试导入功能

#### 🔧 技术改进

- **事务支持**：数据库操作使用事务，确保数据一致性
- **级联删除**：外键约束支持级联操作
- **错误恢复**：完善的错误处理和回滚机制
- **性能监控**：导入进度实时显示

### v3.3.1 (2025-01-20)

#### 🗄️ 数据库升级
- 🔧 **MySQL集成**：用户数据从文件存储迁移到MySQL数据库
  - 新增 `config.php` 数据库配置文件
  - 新增 `create_users.sql` 用户表结构和默认数据
  - 完整的用户管理数据库支持

#### 🛡️ 安全增强
- 🔐 **安全认证**：基于MySQL的用户认证系统
  - 密码哈希存储（password_hash）
  - 角色权限管理（admin/user）
  - 会话管理和登录日志
  - 数据库参数配置（非硬编码）

#### 📁 文件结构调整
- 📝 **配置管理**：
  - 独立的数据库配置文件
  - 用户表SQL创建脚本
  - 安全的凭据管理建议
- 🗂️ **新增文件**：
  - `api/config.php` - 数据库连接配置
  - `create_users.sql` - 用户表结构和数据

#### 📖 文档更新
- 📘 **部署指南**：新增MySQL数据库配置步骤
- 🛡️ **安全配置**：数据库安全最佳实践
- 🔧 **SQL文档**：完整的用户表结构说明
- ✅ **部署检查清单**：确保安全部署的必要步骤

#### ⚠️ 重要提醒
- **部署后操作**：立即修改默认密码
- **安全建议**：使用专用数据库用户
- **配置文件**：不要将凭据提交到版本控制

### v3.3.0 (2025-01-20)

#### 🎉 新增功能
- ✨ **智能路线着色系统**：根据行程连贯性自动分配颜色
  - 连贯路线使用同一颜色（如：北京→杭州→上海）
  - 不连贯时自动切换颜色
  - 时序标记与路线颜色同步
  - 控制台输出详细的连贯性分析日志

#### 🎨 UI/UX优化
- 🔧 **地图控件布局优化**：
  - 时序开关从图例中独立出来
  - 所有控件（图例、时序、全屏）顶部对齐
  - 统一间距（top: 10px），最小化占用
  - 全屏模式下自动调整位置（top: 70px）
- 📐 **紧凑设计**：
  - 减小图例尺寸和间距
  - 图标从20px缩小到18px
  - padding优化，释放更多地图空间
- 🗑️ **移除冗余功能**：删除图例收起/展开功能

#### 🔧 技术改进
- 🎯 **颜色分配算法**：
  - 从基于次数分配改为基于连贯性分配
  - 新增 `tripColorMap` 存储每个行程的颜色索引
  - 优化颜色传递机制
- 📊 **调试增强**：控制台输出每个行程的连贯性分析

#### 📝 文档更新
- 📖 完整的智能路线着色系统说明
- 🎯 地图交互优化详细文档
- 🖼️ 控件布局示意图

### v3.2.0 (2025-01-20)

#### 🎉 新增功能
- ✨ **全屏显示**：地图右上角新增全屏按钮
  - 一键全屏查看地图
  - 支持ESC键快速退出
  - 自动调整地图尺寸
  - 美观的按钮设计和交互效果

#### 📝 文档更新
- 📖 更新README，添加全屏功能使用说明
- 🎯 完善高级功能章节

### v3.1.0 (2025-01-20)

#### 🎉 新增功能
- ✨ **Excel文件支持**：可上传 `.xlsx` 和 `.xls` 文件
- ✨ **智能列识别**：自动识别中英文列名
- ✨ **Excel日期转换**：自动转换Excel序列日期
- 🎨 **地图交互优化**：
  - 移除城市标签，使用地图自带标签
  - 标记点改为小圆点（8px）
  - 鼠标悬停显示详细信息

#### 🔧 优化改进
- 🚀 **文件识别增强**：`.csv`、`.xlsx`、`.xls` 统一处理
- 🎯 **坐标系统**：完善 WGS84 → GCJ02 自动转换
- 📝 **文档整合**：所有说明整合到 README
- 🧹 **代码清理**：删除测试文件和冗余文档

#### 🗑️ 清理文件
- 删除测试工具（`test-*.html`、`test-*.bat`）
- 删除冗余文档（整合到README）
- 删除临时配置文件

### v3.0.0 (2024-12-20)

#### 🗺️ 重大更新
- **地图服务迁移**：从 Leaflet + OpenStreetMap 升级到高德地图
- **性能提升**：国内访问速度提升 75%
- **稳定性改善**：解决OSM加载不稳定问题

#### ✨ 新增功能
- 高德地图集成
- 坐标自动转换（WGS84 → GCJ02）
- 地图控件（缩放、比例尺）
- 自动适配视图

### v2.1.0 (2025-01-19)

#### 🔐 认证系统
- 全局用户认证
- 基于角色的权限控制
- 7天会话有效期
- 用户菜单组件

### v2.0.0 (2025-01-19)

#### ✨ 核心功能
- 行程编辑功能
- CSV上传支持
- 数据预览和验证
- 自动备份机制
- Toast通知系统

### v1.0.0 (初始版本)

#### 🎯 基础功能
- 地图展示
- 日期筛选
- 路径绘制
- 响应式设计

---

## 🎯 为什么选择高德地图？

相比 OpenStreetMap：

| 特性 | OpenStreetMap | 高德地图 |
|------|---------------|----------|
| 🚀 国内访问速度 | ⚠️ 慢（3-8秒） | ✅ 快（1-2秒） |
| 📡 稳定性 | ⚠️ 不稳定 | ✅ 非常稳定 |
| 🗺️ 中文地图 | ⚠️ 一般 | ✅ 优秀 |
| 💰 免费额度 | ✅ 无限制 | ✅ 30万次/天 |
| 🔄 数据更新 | ⚠️ 滞后 | ✅ 实时更新 |
| ⚙️ 配置难度 | ✅ 无需配置 | ⚠️ 需申请Key |

**推荐场景**：
- ✅ 国内用户访问的项目
- ✅ 需要稳定地图服务
- ✅ 对中文显示有要求
- ✅ 个人项目（免费额度充足）

---

## 📱 浏览器支持

| 浏览器 | 最低版本 |
|--------|----------|
| Chrome | 70+ |
| Firefox | 65+ |
| Safari | 12+ |
| Edge | 79+ |
| 移动浏览器 | 支持 |

---

## 📄 许可证

MIT License

版权所有 (c) 2025

特此免费授予任何获得本软件及相关文档文件（"软件"）副本的人不受限制地处置该软件的权利。

---

## 🤝 贡献

欢迎提交 Issue 和 Pull Request！

**贡献指南**：
1. Fork 本仓库
2. 创建特性分支 (`git checkout -b feature/AmazingFeature`)
3. 提交更改 (`git commit -m 'Add some AmazingFeature'`)
4. 推送到分支 (`git push origin feature/AmazingFeature`)
5. 开启 Pull Request

---

## 📞 支持

- 📖 **完整文档**：本 README 包含所有使用说明
- 📧 **问题反馈**：提交 GitHub Issue
- 🌐 **高德地图文档**：https://lbs.amap.com/api/javascript-api/summary
- 💡 **技术支持**：查看常见问题章节

---

**感谢使用路线可视化展示系统！** 🎉

如有问题或建议，欢迎随时提出！
